<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Example Create a catalog - Citrix XenApp and XenDesktop SDK</title>
  

  <link rel="shortcut icon" href="
https://www.citrix.com/etc/designs/citrix/icon-favicon.png">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" href="../css/override.css" type="text/css" />

  
  <script>
    // Current page data
    var mkdocs_page_name = "Example Create a catalog";
    var mkdocs_page_input_path = "example1.md";
    var mkdocs_page_url = "/example1/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

	<div class="header-top">
		<div class="header-top-left">
			<a href="http://www.citrix.com" class="logo-position"><img height="60" src="https://thumbnail-ec2.sharefile.com/thumbnail.aspx?encparams=ypL2J0l-In6gqXJ7yeyKP8A1rqwKMH-C8-nfkJcHJNIN7Y0yZiJsYOcUe-uc0YeZzWLQSFSd1FnuMHPa30XSSINHuGOA8nvvnBT5WmjGlKvd5mxJ4IfT7iTVyHELwhWQiNCznPCiIFyhkA78uKX77PlU2iyhM4YdRM1NKabBe-4wXuiFJsbtAxyJ2UukO_E2ZSf1W3l75Dw8G0zflVkT-EFqyx1zSGId0qzLjm6nzJ8dA9zo-1AJzUisdzmGMzHOq_LMsOWyaalvmcWvCkl-q10GBSbfekfTIFW9LpZNYjkLNSnK8rcwNjWVr_jYayrGjIj2e5dDIMiDj3NRvW51AvHRjxYH9xRRRtY$" target="_blank" class="logo-citrix"><span style="color:#fff;font-size: 20px;position: relative;top:4px;left: 5px">SDK Reference</span></a>
		</div>
		<div class="header-top-right">
			<ul>
			<!--	<li class="list-inline home"><a href="..">HOME</a></li>
				<li class="list-inline support"><a href="http://support.citrix.com">SUPPORT</a></li>-->
				<form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
            <li class="list-inline support"><input name="q" id="txtName" type="text" placeholder="Search SDKs" 
            class="searchdocs">
<a class="fa fa-search errspan"></a></li>
</form>
				<!--<li class="list-inline"><a href="http://citrix.com/download">DOWNLOADS</a></li>-->
			</ul>

		</div>
	</div>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
	<i class="fa fa-search"></i>
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Overview</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../understandxd/">Understanding the XenDesktop Administration Model</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../getstarted/">Getting Started Guide</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Examples</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Example Create a catalog</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#example-create-a-catalog">Example: Create a catalog</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../example2/">Example Create and configure a host</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../example3/">Example Create a PvD Desktop</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../example4/">Example Get load balancing information</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      


      
      <div class="wy-nav-content">
        <div class="rst-content">
         <!-- <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Examples &raquo;</li>
        
      
    
    <li>Example Create a catalog</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/ajitchelat/AppDNA-SDK.git" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div> -->
          <div role="main">
            <div class="section">
             
                <h2 id="example-create-a-catalog"><a class="toclink" href="#example-create-a-catalog">Example: Create a catalog</a></h2>
<p>The following example shows how to create a catalog for a set of Machine Creation Services
(MCS) machines.</p>
<p>Before you begin, make sure you follow the steps detailed in <a href="http://docs.citrix.com/en-us/xenapp-and-xendesktop/7-6/cds-sdk-wrapper-rho/cds-sdk-use-XD-sdk.html"><em>Get started with the
SDK</em></a>.</p>
<p>This document tells you how to use Studio to perform the operation you want to script (in this case, to create a catalog for a set of Machine Creation Services machines) and collect the log of SDK operations that Studio made to perform the task. This output can then be customized to produce a script for automating catalog creation.</p>
<p><strong>Note:</strong> To ensure you always get the latest enhancements and fixes, Citrix recommends you
follow the procedure described in this document, rather than copying and pasting the example script. Line numbers and line breaks have been added to the script for readability.</p>
<p><strong>Understand the script</strong></p>
<p>The following section explains what each part of the script produced by Studio is doing. This
will help you with the customization of your own script. Line numbers have been added for readability.</p>
<div class="codehilite"><pre><span class="n">1</span><span class="p">.</span> <span class="nb">Start-LogHighLevelOperation</span> <span class="n">-AdminAddress</span>
<span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-Source</span> <span class="s1">&#39;Studio&#39;</span> <span class="n">-StartTime</span> <span class="n">29</span><span class="p">/</span><span class="n">05</span><span class="p">/</span><span class="n">2013</span> <span class="n">14</span><span class="err">:</span><span class="n">43</span><span class="err">:</span><span class="n">08</span> <span class="n">-Text</span> <span class="s1">&#39;Create Machine Catalog `&#39;</span><span class="n">ExampleMachines</span><span class="p">`&#39;</span><span class="err">&#39;</span>
</pre></div>


<p>Starts a logged operation and returns a log ID which is supplied to subsequent
operations to associate them with the larger task.</p>
<div class="codehilite"><pre><span class="n">2</span><span class="p">.</span> <span class="nb">New-BrokerCatalog</span>
<span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-AllocationType</span> <span class="s1">&#39;Permanent&#39;</span> <span class="n">-Description</span> <span class="s1">&#39;Example Machines&#39;</span> <span class="n">-IsRemotePC</span> <span class="nv">$False</span> <span class="n">-LoggingId</span>
<span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-MinimumFunctionalLevel</span> <span class="s1">&#39;L7&#39;</span> <span class="n">-Name</span> <span class="s1">&#39;ExampleMachines&#39;</span> <span class="n">-PersistUserChanges</span> <span class="s1">&#39;OnPvd&#39;</span> <span class="n">-ProvisioningType</span> <span class="s1">&#39;MCS&#39;</span> <span class="n">-Scope</span> <span class="p">@()</span> 
<span class="n">-SessionSupport</span> <span class="s1">&#39;SingleSession&#39;</span>
</pre></div>


<p>Creates a Broker
catalog. This catalog is populated with machines which are about to be
created.</p>
<div class="codehilite"><pre><span class="n">3</span><span class="p">.</span> <span class="nb">New-AcctIdentityPool</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-AllowUnicode</span> <span class="n">-Domain</span> <span class="s1">&#39;dumdev.internal.citrix.com&#39;</span> 
   <span class="n">-IdentityPoolName</span> <span class="s1">&#39;ExampleMachines&#39;</span> <span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-NamingScheme</span> <span class="s1">&#39;Example-####&#39;</span> <span class="n">-NamingSchemeType</span> <span class="s1">&#39;Numeric&#39;</span> 
   <span class="n">-OU</span> <span class="s1">&#39;OU=DUMVMs,DC=dumdev,DC=internal,DC=citrix,DC=com&#39;</span> <span class="n">-Scope</span> <span class="p">@()</span>
</pre></div>


<p>Creates an Identity Pool. This defines the mechanism for creating AD computer accounts. This
becomes a container for AD accounts created for the machines that are to be created.</p>
<div class="codehilite"><pre><span class="n">4</span><span class="p">.</span> <span class="nb">Set-BrokerCatalogMetadata</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-CatalogId</span> <span class="n">1</span> <span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-Name</span>
<span class="s1">&#39;Citrix_DesktopStudio_IdentityPoolUid&#39;</span> <span class="n">-Value</span> <span class="s1">&#39;b99aee6d-8772-4dbc-978b-8eb9a26e2407&#39;</span>
</pre></div>


<p>Sets metadata on the Broker catalog with details of the Identity Pool. This is not essential.</p>
<div class="codehilite"><pre><span class="n">5</span><span class="p">.</span> <span class="nb">Test-ProvSchemeNameAvailable</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-ProvisioningSchemeName</span> <span class="p">@(</span><span class="s1">&#39;ExampleMachines&#39;</span><span class="p">)</span>
</pre></div>


<p>Checks that the requested name is available. This is not essential.</p>
<div class="codehilite"><pre><span class="n">6</span><span class="p">.</span> <span class="nb">New-ProvScheme</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-CleanOnBoot</span> <span class="n">-HostingUnitName</span> <span class="s1">&#39;SharedNFS&#39;</span> <span class="n">-IdentityPoolName</span> <span class="s1">&#39;ExampleMachines&#39;</span> <span class="n">-LoggingId</span>
<span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-MasterImageVM</span> <span class="s1">&#39;XDHyp:\hostingunits\SharedNFS\BaseVM.vm\Base OS,</span>
<span class="s1">domain joined and activated.snapshot \Pre-reqs installed.snapshot\\Updates Applied.snapshot\VDA75-no agent.snapshot\Updated Agent.snapshot&#39;</span> 
<span class="n">-NetworkMapping</span> <span class="p">@{</span><span class="n">0</span><span class="p">=</span><span class="s1">&#39;xdhyp:\hostingunits\SharedNFS\Network0.network&#39;</span><span class="p">}</span> <span class="n">-PersonalVDiskDriveLetter</span> <span class="n">P</span> <span class="n">-PersonalVDiskDriveSize</span> <span class="n">10</span> <span class="n">-ProvisioningSchemeName</span> <span class="s1">&#39;ExampleMachines&#39;</span> 
<span class="n">-RunAsynchronously</span> <span class="n">-Scope</span> <span class="p">@()</span> <span class="n">-UsePersonalVDiskStorage</span> <span class="n">-VMCpuCount</span> <span class="n">1</span> <span class="n">-VMMemoryMB</span> <span class="n">1024</span>
</pre></div>


<p>Creates a provisioning scheme object. This is a template for the machines that are to be created. It specifies the hypervisor, network, storage, memory, number of CPUs to be used etc. It takes parameters from the system already set up, such as the HostingUnit name and the path to the VM snapshot to be used for the machines to be created. This command makes a 'consolidated' copy of the VM snapshot being used and, as a result, the process can take time to complete.</p>
<p>In this example, the Studio script specified the -RunAsyncronous flag on this command. This means the command will return control to the administrator before it has completed, so you must wait for it to finish before performing any operations that require it to be complete. If this flag is not specified, the command runs synchronously in-line and control is not returned until the command completes (successfully or otherwise). You can check the status of an asynchronous task using the Get-ProvTask cmdlet. Supply the task ID returned from the operation that started the task; in this case, the New-ProvScheme cmdlet.</p>
<div class="codehilite"><pre><span class="n">7</span><span class="p">.</span> <span class="nb">Set-BrokerCatalog</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-Name</span> <span class="s1">&#39;ExampleMachines&#39;</span> 
   <span class="n">-ProvisioningSchemeId</span> <span class="n">76125e3a</span><span class="p">-</span><span class="n">9001</span><span class="p">-</span><span class="n">4993</span><span class="p">-</span><span class="n">86b6-eefc85c87880</span>
</pre></div>


<p>Updates the BrokerCatalog with the unique Id of the provisioning scheme created above.</p>
<div class="codehilite"><pre><span class="n">8</span><span class="p">.</span> <span class="nb">Add-ProvSchemeControllerAddress</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-ControllerAddress</span> <span class="p">@(</span><span class="s1">&#39;DDC.dumdev.internal.citrix.com&#39;</span><span class="p">)</span> 
<span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-ProvisioningSchemeName</span> <span class="s1">&#39;ExampleMachines&#39;</span>
</pre></div>


<p>Adds a set of controller addresses to the provisioning scheme object. This is a list of addresses that the machines created can use to register with a Controller (broker) when deployed. The machines' registration addresses can be supplied in many ways; however, this information is required if the administrator wants to use the 'Allow Machine Creation Service to supply this' in the VDA installer. Changes to this list affect only machines created after the change, not existing machines.</p>
<div class="codehilite"><pre><span class="n">9</span><span class="p">.</span> <span class="nb">Get-AcctADAccount</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-IdentityPoolUid</span> <span class="n">b99aee6d</span><span class="p">-</span><span class="n">8772</span><span class="p">-</span><span class="n">4dbc</span><span class="p">-</span><span class="n">978b</span><span class="p">-</span><span class="n">8eb9a26e2407</span> <span class="n">-Lock</span> <span class="nv">$False</span> <span class="n">-MaxRecordCount</span> <span class="n">2147483647</span> <span class="n">-State</span> <span class="s1">&#39;Available&#39;</span>
</pre></div>


<p>Studio gets a list of available Machine Identities from the Identity Pool so that, if existing accounts have been created in the past but are unused, these can be consumed instead of creating new accounts. Note that this is not required in a script because new accounts can be created instead, provided the script is running in a context that has permissions to do this. However, if the script does not have permissions to create accounts, change the script to consume available accounts (a separate process will be required to provide a pool of accounts into the Identity Pool, before running the script).</p>
<div class="codehilite"><pre><span class="n">10</span><span class="p">.</span> <span class="nb">New-AcctADAccount</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-Count</span> <span class="n">2</span> <span class="n">-IdentityPoolUid</span> <span class="n">b99aee6d</span><span class="p">-</span><span class="n">8772</span><span class="p">-</span><span class="n">4dbc</span><span class="p">-</span><span class="n">978b</span><span class="p">-</span><span class="n">8eb9a26e2407</span> <span class="n">-LoggingId</span>
<span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span>
</pre></div>


<p>Creates the required AD computer accounts in Active Directory. The script creates one account
but, if required, it can create more using the 'Count' parameter of the command. The accounts are created into the OU defined in the provisioning scheme created above.</p>
<div class="codehilite"><pre><span class="n">11</span><span class="p">.</span> <span class="nb">New-ProvVM</span> <span class="n">-ADAccountName</span> <span class="p">@(</span><span class="s1">&#39;DUMDEV\Example-0001\$&#39;</span><span class="p">,</span><span class="s1">&#39;DUMDEV\Example-0002\$&#39;</span><span class="p">)</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-LoggingId</span>
<span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-ProvisioningSchemeName</span> <span class="s1">&#39;ExampleMachines&#39;</span> <span class="n">-RunAsynchronously</span>
</pre></div>


<p>Creates virtual machines, based on the template definition in the provisioning scheme
created above. This process may take time to complete.</p>
<div class="codehilite"><pre><span class="n">12</span><span class="p">.</span> <span class="n">Lock-ProvVM</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> 
    <span class="n">-ProvisioningSchemeName</span> <span class="s1">&#39;ExampleMachines&#39;</span> <span class="n">-Tag</span> <span class="s1">&#39;Brokered&#39;</span> <span class="n">-VMID</span> <span class="p">@(</span><span class="s1">&#39;0710bb77-d01f-d006-4d67-5472e5cd349f&#39;</span><span class="p">)</span>
</pre></div>


<p>Locks the provisioned virtual machines and prevents accidental modification of the virtual
machine. Consumers of the SDK can use this to indicate that the virtual machine is in use and why it is locked. The script locks the VM with a tag of 'Brokered' to indicate the virtual machine is created and added to a Broker catalog and must not be deleted without first being removed from the catalog. You can set the Tag name to whatever is required.</p>
<div class="codehilite"><pre><span class="n">13</span><span class="p">.</span> <span class="nb">New-BrokerMachine</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-CatalogUid</span> <span class="n">1</span> <span class="n">-HostedMachineId</span> <span class="s1">&#39;0710bb77-d01f-d006-4d67-5472e5cd349f&#39;</span> <span class="n">-HypervisorConnectionUid</span> <span class="n">1</span>
<span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-MachineName</span> <span class="s1">&#39;S-1-5-21-3918710733-2340574387-1999698698-109114&#39;</span>
</pre></div>


<p>Creates a Broker Machine object. These are objects stored in the catalog which join the
provisioned machine with the catalog.</p>
<div class="codehilite"><pre><span class="n">14</span><span class="p">.</span> <span class="nb">Start-BrokerMachinePvdImagePrepare</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-InputObject</span> <span class="p">@(</span><span class="n">2</span><span class="p">)</span> <span class="n">-LoggingId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span>
</pre></div>


<p>Requests the Broker Service to initiate a preparation operation for Personal vDisk. This is required to allow the machine to initialize the storage for Personal vDisk.</p>
<div class="codehilite"><pre><span class="n">15</span><span class="p">.</span> <span class="nb">Stop-LogHighLevelOperation</span> <span class="n">-AdminAddress</span> <span class="s1">&#39;ddc.dumdev.internal.citrix.com:80&#39;</span> <span class="n">-HighLevelOperationId</span> <span class="n">f39a2792</span><span class="p">-</span><span class="n">064a</span><span class="p">-</span><span class="n">43eb</span><span class="p">-</span><span class="n">97c7</span><span class="p">-</span><span class="n">397cc1238e46</span> <span class="n">-IsSuccessful</span> <span class="nv">$true</span>
</pre></div>


<p>Stops the logged operation begun in the first step and indicates it was successful.</p>
<p><strong>Customize the script</strong></p>
<p>The following section shows how to convert and adapt the Studio output into a script that is
more consumable. In addition to using variables and removing commands that are not required, it shows how to add machine creation into a loop so that you can control the number of machines created. Line numbers have been added for readability.</p>
<div class="codehilite"><pre><span class="n">1</span><span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>

<span class="k">param</span>

<span class="p">(</span>

<span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="no">[string]</span> <span class="nv">$hostingUnitPath</span><span class="p">,</span>

<span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="no">[string]</span> <span class="nv">$catalogName</span><span class="p">,</span>

<span class="no">[string]</span> <span class="nv">$catalogDescription</span><span class="p">,</span>

<span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="no">[int]</span> <span class="nv">$numVmsToCreate</span><span class="p">,</span>

<span class="no">[string]</span> <span class="nv">$adminAddress</span><span class="p">,</span>

<span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="no">[string]</span> <span class="nv">$namingScheme</span><span class="p">,</span>

<span class="no">[string]</span> <span class="nv">$OU</span><span class="p">,</span>

<span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="no">[string]</span> <span class="nv">$domain</span><span class="p">,</span>

<span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="no">[string]</span> <span class="nv">$masterImagePath</span>

<span class="p">)</span>

<span class="n">2</span><span class="p">.</span> <span class="nb">Set-HypAdminConnection</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">3</span><span class="p">.</span> <span class="nv">$hostingUnit</span> <span class="p">=</span> <span class="nb">get-item</span> <span class="nv">$hostingUnitPath</span>

<span class="n">4</span><span class="p">.</span> <span class="nv">$hostConnection</span> <span class="p">=</span> <span class="nv">$hostingUnit</span><span class="p">.</span><span class="n">hypervisorConnection</span>

<span class="n">5</span><span class="p">.</span> <span class="nv">$brokerHypConnection</span> <span class="p">=</span> <span class="nb">Get-BrokerHypervisorConnection</span> <span class="n">-HypHypervisorConnectionUid</span> <span class="nv">$hostConnection</span><span class="p">.</span><span class="n">HypervisorConnectionUid</span>

<span class="n">6</span><span class="p">.</span> <span class="c"># Start logged operation</span>

<span class="n">7</span><span class="p">.</span> <span class="nv">$loggingOp</span> <span class="p">=</span> <span class="nb">Start-LogHighLevelOperation</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span> <span class="n">-Source</span> <span class="s1">&#39;Scripted&#39;</span> <span class="n">-Text</span> <span class="s2">&quot;Create Machine Catalog </span><span class="se">`&#39;</span><span class="s2">$catalogName</span><span class="se">`&#39;</span><span class="s2">&quot;</span>

<span class="n">8</span><span class="p">.</span> <span class="nv">$loggingId</span> <span class="p">=</span> <span class="nv">$loggingOp</span><span class="p">.</span><span class="n">Id</span>

<span class="n">9</span><span class="p">.</span> <span class="c"># Create the broker catalog and the AD Identity account pool</span>

<span class="n">10</span><span class="p">.</span> <span class="nv">$catalog</span> <span class="p">=</span> <span class="nb">New-BrokerCatalog</span> <span class="n">-AllocationType</span> <span class="s1">&#39;Permanent&#39;</span> <span class="n">-Description</span> <span class="nv">$catalogDescription</span> <span class="n">-IsRemotePC</span> <span class="nv">$False</span>

<span class="n">-MinimumFunctionalLevel</span> <span class="s1">&#39;L7&#39;</span> <span class="n">-Name</span> <span class="nv">$catalogName</span> <span class="n">-PersistUserChanges</span>
<span class="s1">&#39;OnPvd&#39;</span> <span class="n">-ProvisioningType</span> <span class="s1">&#39;MCS&#39;</span> <span class="n">-Scope</span> <span class="p">@()</span> <span class="n">-SessionSupport</span> <span class="s1">&#39;SingleSession&#39;</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span>
<span class="nv">$adminAddress</span>

<span class="n">11</span><span class="p">.</span> <span class="nv">$adPool</span> <span class="p">=</span> <span class="nb">New-AcctIdentityPool</span> <span class="n">-IdentityPoolName</span> <span class="nv">$catalogName</span>
<span class="n">-NamingScheme</span> <span class="nv">$namingScheme</span>

<span class="n">-NamingSchemeType</span> <span class="s1">&#39;Numeric&#39;</span> <span class="n">-OU</span> <span class="nv">$OU</span> <span class="n">-Domain</span> <span class="nv">$domain</span> <span class="n">-AllowUnicode</span>
<span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">12</span><span class="p">.</span> <span class="nb">Set-BrokerCatalogMetadata</span> <span class="n">-CatalogId</span> <span class="nv">$catalog</span><span class="p">.</span><span class="n">Uid</span> <span class="n">-Name</span>
<span class="s1">&#39;Citrix_DesktopStudio_IdentityPoolUid&#39;</span> <span class="n">-Value</span> <span class="nv">$adPool</span><span class="p">.</span><span class="n">IdentityPoolUid</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span>
<span class="nv">$adminAddress</span>

<span class="n">13</span><span class="p">.</span> <span class="c">###################################################################</span>

<span class="n">14</span><span class="p">.</span> <span class="c">#create the ProvisioningScheme and wait for it to complete (reporting progress)</span>

<span class="n">15</span><span class="p">.</span> <span class="nv">$provSchemeTaskID</span> <span class="p">=</span> <span class="nb">New-ProvScheme</span> <span class="n">-ProvisioningSchemeName</span>
<span class="nv">$catalogName</span> <span class="n">-HostingUnitUID</span> <span class="nv">$hostingUnit</span><span class="p">.</span><span class="n">HostingUnitUID</span>

<span class="n">-IdentityPoolUID</span> <span class="nv">$adpool</span><span class="p">.</span><span class="n">IdentityPoolUid</span> <span class="n">-CleanOnBoot</span> <span class="n">-MasterImageVM</span>
<span class="nv">$masterImagePath</span> <span class="n">-UsePersonalVDiskStorage</span>

<span class="n">-PersonalVDiskDriveLetter</span> <span class="n">P</span> <span class="n">-PersonalVDiskDriveSize</span> <span class="n">10</span> <span class="n">-RunAsynchronously</span> 
<span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">16</span><span class="p">.</span> <span class="nv">$ProvTask</span> <span class="p">=</span> <span class="nb">get-provTask</span> <span class="n">-TaskID</span> <span class="nv">$provSchemeTaskID</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">17</span><span class="p">.</span> <span class="nv">$taskProgress</span> <span class="p">=</span> <span class="n">0</span>

<span class="n">18</span><span class="p">.</span> <span class="nb">write-host</span> <span class="s2">&quot;Creating New ProvScheme&quot;</span>

<span class="n">19</span><span class="p">.</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$provTask</span><span class="p">.</span><span class="n">Active</span> <span class="o">-eq</span> <span class="nv">$true</span><span class="p">)</span>

<span class="n">20</span><span class="p">.</span> <span class="p">{</span>

<span class="n">21</span><span class="p">.</span> <span class="c"># catch an uninitialized task progress, this occurs until the product initialized the value</span>

<span class="n">22</span><span class="p">.</span> <span class="k">try</span> <span class="p">{</span><span class="nv">$totalPercent</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$provTask</span><span class="p">.</span><span class="n">TaskProgress</span><span class="p">){</span><span class="nv">$provTask</span><span class="p">.</span><span class="n">TaskProgress</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="n">0</span><span class="p">}}</span> <span class="k">catch</span> <span class="p">{}</span>

<span class="n">23</span><span class="p">.</span> <span class="nb">Write-Progress</span> <span class="n">-activity</span> <span class="s2">&quot;Creating Provisioning Scheme:&quot;</span> <span class="n">-status</span> <span class="s2">&quot;$totalPercent% Complete:&quot;</span> <span class="n">-percentcomplete</span> <span class="nv">$totalPercent</span>

<span class="n">24</span><span class="p">.</span> <span class="n">sleep</span> <span class="n">30</span>

<span class="n">25</span><span class="p">.</span> <span class="nv">$ProvTask</span> <span class="p">=</span> <span class="nb">get-provTask</span> <span class="n">-TaskID</span> <span class="nv">$provSchemeTaskID</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">26</span><span class="p">.</span> <span class="p">}</span>

<span class="n">27</span><span class="p">.</span> <span class="nb">write-host</span> <span class="s2">&quot;New ProvScheme Creation Finished&quot;</span>

<span class="n">28</span><span class="p">.</span> <span class="nv">$provScheme</span> <span class="p">=</span> <span class="nb">get-provScheme</span> <span class="n">-ProvisioningSchemeUID</span> <span class="nv">$provTask</span><span class="p">.</span><span class="n">ProvisioningSchemeUid</span>

<span class="n">29</span><span class="p">.</span> <span class="nv">$controllers</span> <span class="p">=</span> <span class="nb">Get-BrokerController</span> <span class="p">|</span> <span class="n">select</span> <span class="n">DNSName</span>

<span class="n">30</span><span class="p">.</span> <span class="nb">Add-ProvSchemeControllerAddress</span> <span class="n">-ProvisioningSchemeUID</span> <span class="nv">$provScheme</span><span class="p">.</span><span class="n">ProvisioningSchemeUID</span> <span class="n">-ControllerAddress</span> <span class="nv">$controllers</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">31</span><span class="p">.</span> <span class="c">###################################################################</span>

<span class="n">32</span><span class="p">.</span> <span class="c"># Set the provisioning scheme id for the broker catalog</span>

<span class="n">33</span><span class="p">.</span> <span class="nb">Set-BrokerCatalog</span> <span class="n">-InputObject</span> <span class="nv">$catalog</span> <span class="n">-ProvisioningSchemeId</span> <span class="nv">$provTask</span><span class="p">.</span><span class="n">ProvisioningSchemeUid</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">34</span><span class="p">.</span> <span class="c">###################################################################</span>

<span class="n">35</span><span class="p">.</span> <span class="c"># create the AD accounts required and then create the Virtual machines (reporting progress)</span>

<span class="n">36</span><span class="p">.</span> <span class="nv">$accts</span> <span class="p">=</span> <span class="nb">New-AcctADAccount</span> <span class="n">-IdentityPoolUid</span> <span class="nv">$adPool</span><span class="p">.</span><span class="n">IdentityPoolUid</span> <span class="n">-Count</span> <span class="nv">$numVMsToCreate</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">37</span><span class="p">.</span> <span class="nv">$provVMTaskID</span> <span class="p">=</span> <span class="nb">New-ProvVM</span> <span class="n">-ProvisioningSchemeUID</span> <span class="nv">$provScheme</span><span class="p">.</span><span class="n">ProvisioningSchemeUID</span>

<span class="n">-ADAccountName</span> <span class="nv">$accts</span><span class="p">.</span><span class="n">SuccessfulAccounts</span> <span class="n">-RunAsynchronously</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">38</span><span class="p">.</span> <span class="c"># wait for the VMS to finish Provisioning</span>

<span class="n">39</span><span class="p">.</span> <span class="nv">$ProvTask</span> <span class="p">=</span> <span class="nb">get-provTask</span> <span class="n">-TaskID</span> <span class="nv">$provVMTaskID</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">40</span><span class="p">.</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$provTask</span><span class="p">.</span><span class="n">Active</span> <span class="o">-eq</span> <span class="nv">$true</span><span class="p">)</span>

<span class="n">41</span><span class="p">.</span> <span class="p">{</span>

<span class="n">42</span><span class="p">.</span> <span class="c"># catch an uninitialized task progress, this occurs until the product initialized the value</span>

<span class="n">43</span><span class="p">.</span> <span class="k">try</span> <span class="p">{</span><span class="nv">$totalPercent</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$provTask</span><span class="p">.</span><span class="n">TaskProgress</span><span class="p">){</span><span class="nv">$provTask</span><span class="p">.</span><span class="n">TaskProgress</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="n">0</span><span class="p">}}</span> <span class="k">catch</span> <span class="p">{}</span>

<span class="n">44</span><span class="p">.</span> <span class="nb">Write-Progress</span> <span class="n">-activity</span> <span class="s2">&quot;Creating Machines:&quot;</span> <span class="n">-status</span> <span class="s2">&quot;$totalPercent% Complete:&quot;</span> <span class="n">-percentcomplete</span> <span class="nv">$totalPercent</span>

<span class="n">45</span><span class="p">.</span> <span class="n">sleep</span> <span class="n">5</span>

<span class="n">46</span><span class="p">.</span> <span class="nv">$ProvTask</span> <span class="p">=</span> <span class="nb">get-provTask</span> <span class="n">-TaskID</span> <span class="nv">$provVMTaskID</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">47</span><span class="p">.</span> <span class="p">}</span>

<span class="n">48</span><span class="p">.</span> <span class="nb">write-host</span> <span class="s2">&quot;VM Creation Finished&quot;</span>

<span class="n">49</span><span class="p">.</span> <span class="c"># Lock the VMs and add them to the broker Catalog</span>

<span class="n">50</span><span class="p">.</span> <span class="nv">$provisionedVMs</span> <span class="p">=</span> <span class="nb">get-ProvVM</span> <span class="n">-ProvisioningSchemeUID</span>
<span class="nv">$provScheme</span><span class="p">.</span><span class="n">ProvisioningSchemeUID</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">51</span><span class="p">.</span> <span class="nv">$provisionedVMs</span> <span class="p">|</span> <span class="n">Lock-ProvVM</span> <span class="n">-ProvisioningSchemeUID</span> <span class="nv">$provScheme</span><span class="p">.</span><span class="n">ProvisioningSchemeUID</span> 
<span class="n">-Tag</span> <span class="s1">&#39;Brokered&#39;</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>

<span class="n">52</span><span class="p">.</span> <span class="nv">$provisionedVMs</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span><span class="nb">New-BrokerMachine</span> <span class="n">-CatalogUid</span> <span class="nv">$catalog</span><span class="p">.</span><span class="n">UID</span> <span class="n">-HostedMachineId</span> <span class="nv">$_</span><span class="p">.</span><span class="n">VMId</span>

<span class="n">-HypervisorConnectionUid</span> <span class="nv">$brokerHypConnection</span><span class="p">.</span><span class="n">UID</span> <span class="n">-MachineName</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ADAccountSid</span> <span class="n">-LoggingId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span><span class="p">}</span>

<span class="n">53</span><span class="p">.</span> <span class="nb">Stop-LogHighLevelOperation</span> <span class="n">-IsSuccessful</span> <span class="nv">$true</span> <span class="n">-HighLevelOperationId</span> <span class="nv">$loggingId</span> <span class="n">-AdminAddress</span> <span class="nv">$adminAddress</span>
</pre></div>
              
               
            </div>
          </div>

        </div>
      </div>

    </section>

  </div>

<!--<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/ajitchelat/AppDNA-SDK.git" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span class="prev"><a href="../getstarted/"><i class="fa fa-angle-left"></i> Previous</a></span>
      
      
        <span class="next"><a href="../example2/">Next <i class="fa fa-angle-right"></i></a></span>
      
    </span>
	<div class="footer-right">
		<ul class="social-links">
			<li class="list-inline"><a href="https://twitter.com/citrix"><i class="fa fa-twitter"></i>@citrix</a></li>
			<li class="list-inline"><a href="mailto:support@citrix.com"><i class="fa fa-envelope-o"></i>support@citrix.com</a></li>
		</ul>
		<ul class="inner-pages">
			<li class="list-inline"><a href="http://citrix.com/about/legal">Privacy and Terms</li>
		</ul>
	</div>
</div>-->

</body>
</html>
